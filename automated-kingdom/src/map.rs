use ak_server::types_game::Texture;
use derive_new::new;
use macroquad::color_u8;
use macroquad::prelude::{uvec2, vec2, UVec2, Vec2, RED, WHITE};
use macroquad::texture::{draw_texture, DrawTextureParams};

use crate::conf::SQUARE_SIZE;
use crate::game::game;
use crate::texture_map::TextureMap;
use crate::util::{draw_rel_rectangle, draw_rel_texture_ex};

#[derive(PartialEq, Eq, Clone, Copy, Debug)]
pub enum Tile {
    Wall,
    Air,
}

#[derive(Clone, PartialEq, Debug, new)]
pub struct Map {
    #[new(value = "string_to_map(TEST_MAP).0")]
    pub map: Vec<Vec<Tile>>,

    #[new(value = "string_to_map(TEST_MAP).1")]
    pub width: usize,

    #[new(value = "string_to_map(TEST_MAP).2")]
    pub height: usize,
}
impl Map {
    pub fn get(&self, pos: UVec2) -> Tile {
        self.map[pos.y as usize][pos.x as usize]
    }

    pub fn draw(&self) {
        for (y, row) in self.map.iter().enumerate() {
            for (x, tile) in row.iter().enumerate() {
                let world_pos = pos_to_world(uvec2(x as u32, y as u32));
                match tile {
                    Tile::Wall => {
                        draw_texture(Texture::Wall.texture(), world_pos.x, world_pos.y, WHITE);
                    }
                    Tile::Air => {}
                }
            }
        }
    }

    pub fn draw_minimap(&self) {
        let new_square_size = SQUARE_SIZE / 20.0;
        let margin = 8.0;

        // Border / background
        let width = self.width as f32 * new_square_size;
        let height = self.height as f32 * new_square_size;
        draw_rel_rectangle(
            0.0,
            0.0,
            width + margin * 2.0,
            height + margin * 2.0,
            color_u8!(150, 111, 51, 255),
        );

        // Minimap
        for (y, row) in self.map.iter().enumerate() {
            for (x, tile) in row.iter().enumerate() {
                match tile {
                    Tile::Wall => {
                        draw_rel_texture_ex(
                            Texture::Wall.texture(),
                            margin + x as f32 * new_square_size,
                            margin + y as f32 * new_square_size,
                            DrawTextureParams {
                                dest_size: Some(vec2(new_square_size, new_square_size)),
                                ..Default::default()
                            },
                        );
                    }
                    Tile::Air => {}
                }
            }
        }

        // Camera view indicator
    }

    pub fn update_camera_bounds(&self) {
        game().camera.bounds = Some(vec2(
            self.width as f32 * SQUARE_SIZE,
            self.height as f32 * SQUARE_SIZE,
        ));
    }
}

/// Inverse of [world_to_pos]. Converts a location on a [Map] to a world position
pub fn pos_to_world(pos: UVec2) -> Vec2 {
    vec2(pos.x as f32 * SQUARE_SIZE, pos.y as f32 * SQUARE_SIZE)
}

/// Inverse of [pos_to_world], converts a world position to a location on a [Map]
pub fn world_to_pos(pos: Vec2) -> UVec2 {
    uvec2((pos.x / SQUARE_SIZE) as u32, (pos.y / SQUARE_SIZE) as u32)
}

fn string_to_map(string: &'static str) -> (Vec<Vec<Tile>>, usize, usize) {
    let mut map = vec![];
    for line in string.lines() {
        let mut row = vec![];
        for c in line.chars() {
            match c {
                '#' => row.push(Tile::Wall),
                '.' => row.push(Tile::Air),
                _ => panic!("Invalid character in map string '{}'", c),
            }
        }
        map.push(row);
    }
    let width = map[0].len();
    let height = map.len();
    (map, width, height)
}

const TEST_MAP: &str = "######################################################################################################################################################
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
#....................................................................................................................................................#
######################################################################################################################################################";
